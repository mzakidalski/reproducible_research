---
title: "The most severe weather events in the United States in terms of the population health and the economic consequences"
author: "Marcin Zakidalski"
date: "23 05 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## The synopsis

This analysis is going to answer the following two questions:

1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?
2. Across the United States, which types of events have the greatest economic consequences?

The data used in this analysis comes from the following source: <https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2>.

## Data Processing

R packages used in the analysis:

```{r, echo=TRUE, warning=FALSE, message=FALSE}
library(readr)
library(ggplot2)
library(dplyr)
library(lubridate)
```

From the data set we are interested only in the following columns:

* STATE - code abbreviating the state
* BGN_DATE, END_DATE - event start/end dates
* PROPDMG / CROPDMG - describes the damage to the property/crop
* PROPDMGEXP / CROPDMGEXP - multipliers to the previous values (k/K for 1000, m/M for 1 000 000, b/B for 1 000 000 000).                                

Data loading & column selection (we assume that the download dataset is present in the working folder):

```{r, echo=TRUE, warning=FALSE, message=FALSE}

all_weather_data <- read_csv("repdata_data_StormData.csv.bz2")
filtered_cols_data <- all_weather_data %>% select(STATE, BGN_DATE, END_DATE, 
                                                  PROPDMG, PROPDMGEXP, CROPDMG, 
                                                  CROPDMGEXP, INJURIES, FATALITIES)
```

According to the documentation of the dataset the COLNAME*EXP columns contain the multiplier
for the COLNAME values. This data contains not only tidy values:

```{r, echo=TRUE, warning=FALSE, message=FALSE}

print( unique(filtered_cols_data$PROPDMGEXP))
print( unique(filtered_cols_data$CROPDMGEXP))
```

The analysis assumption is that:

* allowed multipliers are B, M (which is equivalent to m), K
* all other values (including NAs) are equivalent to 1.0 multiplier

The ALL_* columns will contain the real value (in $) of damages:

```{r, echo=TRUE, warning=FALSE, message=FALSE}
filtered_cols_data <- filtered_cols_data %>%
                          mutate(ALL_PROPDMG = case_when( endsWith(PROPDMGEXP,"B")  ~ 1000000000.0*PROPDMG,
                                                          endsWith(PROPDMGEXP, "M") ~ 1000000.0*PROPDMG,
                                                          endsWith(PROPDMGEXP, "m") ~ 1000000.0*PROPDMG,
                                                          endsWith(PROPDMGEXP, "K") ~ 1000.0*PROPDMG,
                                                          TRUE ~ 1.0*PROPDMG))

# there are no multipliers for the crop-related damage
filtered_cols_data <- filtered_cols_data %>% mutate(ALL_CROPDMG = CROPDMG)
```

We can briefly verify our transformations are correct:
```{r, echo=TRUE, warning=FALSE, message=FALSE}
head(filtered_cols_data %>% filter(PROPDMG > 0) %>% select(-STATE, -BGN_DATE, -END_DATE))
head(filtered_cols_data %>% filter(CROPDMG > 0) %>% select(-STATE, -BGN_DATE, -END_DATE))
```


## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
